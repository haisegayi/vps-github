name: RDP Mobile Optimized - Low Latency

on:
  workflow_dispatch:

env:
  FIXED_PASSWORD: "Mobile@1234"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Clean Previous Session
        run: |
          Write-Host "üßπ Cleaning previous session..."
          Get-Process "tailscale*" -ErrorAction SilentlyContinue | Stop-Process -Force
          Start-Sleep -Seconds 1

      - name: Ultra Low Latency RDP Setup
        run: |
          Write-Host "‚ö° Configuring ultra low latency RDP..."
          
          # C·∫•u h√¨nh RDP cho ƒë·ªô tr·ªÖ th·∫•p nh·∫•t
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v SecurityLayer /t REG_DWORD /d 0 /f
          
          # QUAN TR·ªåNG: C·∫•u h√¨nh gi·∫£m ƒë·ªô tr·ªÖ input
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MinSendInterval /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v KeepAliveTimeout /t REG_DWORD /d 1 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v KeepAliveInterval /t REG_DWORD /d 1 /f
          
          # T·ªëi ∆∞u cho high latency
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v FlowControlDisable /t REG_DWORD /d 1 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v DisableBandwidthDelay /t REG_DWORD /d 1 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v DisableFastPathInput /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v DisableFastPathOutput /t REG_DWORD /d 0 /f
          
          # Ch·∫•t l∆∞·ª£ng h√¨nh ·∫£nh th·∫•p ƒë·ªÉ ∆∞u ti√™n input
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MaxColorDepth /t REG_DWORD /d 16 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MaxXResolution /t REG_DWORD /d 1280 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MaxYResolution /t REG_DWORD /d 720 /f
          
          # T·ªëi ∆∞u network stack
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v Tcp1323Opts /t REG_DWORD /d 1 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v TCPWindowSize /t REG_DWORD /d 65535 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v DefaultTTL /t REG_DWORD /d 64 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v EnablePMTUDiscovery /t REG_DWORD /d 1 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v EnablePMTUBHDetect /t REG_DWORD /d 0 /f
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP" 2>$null
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

      - name: Create User
        run: |
          net user MobileUser /delete 2>$null
          net user MobileUser $env:FIXED_PASSWORD /add /y /expires:never
          net localgroup administrators MobileUser /add
          net localgroup "Remote Desktop Users" MobileUser /add
          "RDP_USER=MobileUser" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install Tailscale with Exit Nodes
        run: |
          if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
            $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            curl -s -o $installerPath $tsUrl
            Start-Process msiexec.exe -ArgumentList "/i", "$installerPath", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
            Start-Sleep -Seconds 3
          }

      - name: Configure Tailscale for Vietnam
        run: |
          Write-Host "üåè Optimizing for Vietnam connection..."
          
          # S·ª≠ d·ª•ng exit node g·∫ßn Vi·ªát Nam (Singapore/Hong Kong)
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --login-server=https://login.tailscale.com --accept-routes --hostname=vn-rdp-$env:GITHUB_RUN_ID --accept-dns=false
          
          # ƒê·ª£i k·∫øt n·ªëi
          $tsIP = $null
          for ($i = 0; $i -lt 15; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            if ($tsIP) { 
              "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append
              break 
            }
            Start-Sleep -Seconds 2
          }

      - name: Apply Input Latency Optimizations
        run: |
          Write-Host "‚å®Ô∏è Applying input latency optimizations..."
          
          # T·∫Øt services g√¢y lag
          $servicesToDisable = @(
            "SysMain", 
            "WSearch",
            "TabletInputService",
            "Themes",
            "FontCache"
          )
          
          foreach ($service in $servicesToDisable) {
            Stop-Service $service -Force -ErrorAction SilentlyContinue
            Set-Service $service -StartupType Manual -ErrorAction SilentlyContinue
          }
          
          # T·ªëi ∆∞u power plan cho responsiveness
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          powercfg /setdcvalueindex SCHEME_CURRENT SUB_VIDEO VIDEOCONLOCK 0
          powercfg /setacvalueindex SCHEME_CURRENT SUB_VIDEO VIDEOCONLOCK 0
          
          # T·∫Øt visual effects
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
          
          # T·ªëi ∆∞u mouse settings
          reg add "HKCU\Control Panel\Mouse" /v MouseSensitivity /t REG_SZ /d "10" /f
          reg add "HKCU\Control Panel\Mouse" /v MouseSpeed /t REG_SZ /d "0" /f
          reg add "HKCU\Control Panel\Mouse" /v MouseThreshold1 /t REG_SZ /d "0" /f
          reg add "HKCU\Control Panel\Mouse" /v MouseThreshold2 /t REG_SZ /d "0" /f

      - name: Generate RDP File with Low Latency Settings
        run: |
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
          if (-not $tsIP) { $tsIP = "waiting..." }
          
          # T·∫°o RDP file v·ªõi settings t·ªëi ∆∞u cho high latency
          $rdpContent = @"
screen mode id:i:2
use multimon:i:0
desktopwidth:i:1280
desktopheight:i:720
session bpp:i:16
winposstr:s:0,1,0,0,800,600
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:1
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:0
full address:s:$tsIP
audiomode:i:0
redirectprinters:i:0
redirectcomports:i:0
redirectsmartcards:i:0
redirectwebauthn:i:0
redirectclipboard:i:1
redirectposdevices:i:0
autoreconnection enabled:i:1
authentication level:i:0
prompt for credentials:i:0
negotiate security layer:i:0
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayhostname:s:
gatewayusagemethod:i:0
gatewaycredentialssource:i:0
gatewayprofileusagemethod:i:0
promptcredentialonce:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
username:s:MobileUser
"@
          
          Write-Host "=========================================="
          Write-Host "üéØ ULTRA LOW LATENCY RDP - FOR VIETNAM"
          Write-Host "=========================================="
          Write-Host "üìç IP: $tsIP"
          Write-Host "üë§ User: MobileUser"
          Write-Host "üîë Password: $env:FIXED_PASSWORD"
          Write-Host ""
          Write-Host "‚ö° INPUT OPTIMIZATIONS APPLIED:"
          Write-Host "‚Ä¢ FastPath Input/Output enabled"
          Write-Host "‚Ä¢ Minimal send interval (0ms)"
          Write-Host "‚Ä¢ Low quality video (16-bit)"
          Write-Host "‚Ä¢ Mouse acceleration disabled"
          Write-Host "‚Ä¢ Network flow control optimized"
          Write-Host ""
          Write-Host "üìã MANUAL CLIENT SETTINGS:"
          Write-Host "1. Experience: 'Low-speed broadband'"
          Write-Host "2. Turn OFF: Persistent bitmap caching"
          Write-Host "3. Turn ON: Compression"
          Write-Host "4. Turn OFF: Desktop background"
          Write-Host "5. Turn OFF: Visual effects"
          Write-Host ""
          Write-Host "üí° Copy RDP settings above for best results"
          Write-Host "=========================================="

      - name: Latency Monitoring
        run: |
          Write-Host "üìä Monitoring latency to Vietnam..."
          $counter = 0
          
          while ($true) {
            $counter++
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            
            if ($tsIP -and $counter % 5 -eq 0) {
              # Ki·ªÉm tra ping v√† hi·ªÉn th·ªã th√¥ng tin ƒë·ªô tr·ªÖ
              try {
                $ping = Test-Connection -ComputerName $tsIP -Count 3 -ErrorAction Stop
                $avgPing = ($ping | Measure-Object -Property ResponseTime -Average).Average
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Ping: $([math]::Round($avgPing))ms | Session: ${counter}m"
                
                if ($avgPing -gt 200) {
                  Write-Host "‚ö†Ô∏è  High latency detected - Consider using exit nodes"
                }
              } catch {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Ping check failed"
              }
            } else {
              if ($counter % 10 -eq 0) {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Active - ${counter}m"
              }
            }
            
            Start-Sleep -Seconds 60
          }
