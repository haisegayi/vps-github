name: RDP Persistent Pro

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Tá»± Ä‘á»™ng cháº¡y láº¡i má»—i 6 giá»

env:
  BACKUP_REPO: "haisegayi/rdp-backup"
  PERSISTENT_USER: "VietnamUser"
  PERSISTENT_PASSWORD: "Vietnam@2024!"

jobs:
  backup-data:
    runs-on: ubuntu-latest
    if: always()  # LuÃ´n cháº¡y ká»ƒ cáº£ khi failed
    steps:
      - name: Backup RDP Data
        if: github.event_name != 'schedule'
        run: |
          echo "ğŸ“¦ Backup process would run here"
          # Trong thá»±c táº¿, báº¡n sáº½ push data lÃªn repo khÃ¡c
          # hoáº·c dÃ¹ng cloud storage

  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600
    needs: backup-data

    steps:
      - name: Checkout Backup Data
        run: |
          Write-Host "ğŸ”„ Checking for previous backup..."
          # Trong thá»±c táº¿, báº¡n sáº½ clone backup repo á»Ÿ Ä‘Ã¢y

      - name: Setup Persistent Environment
        run: |
          Write-Host "ğŸ¯ Setting up persistent environment..."
          
          # Sá»­ dá»¥ng password cá»‘ Ä‘á»‹nh Ä‘á»ƒ dá»… nhá»›
          $securePass = ConvertTo-SecureString $env:PERSISTENT_PASSWORD -AsPlainText -Force
          
          # Táº¡o user cá»‘ Ä‘á»‹nh
          $userExists = Get-LocalUser -Name $env:PERSISTENT_USER -ErrorAction SilentlyContinue
          if (-not $userExists) {
              New-LocalUser -Name $env:PERSISTENT_USER -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $env:PERSISTENT_USER
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:PERSISTENT_USER
              Write-Host "âœ… Created persistent user: $env:PERSISTENT_USER"
          } else {
              Write-Host "âœ… Reusing existing user: $env:PERSISTENT_USER"
          }
          
          "RDP_USER=$env:PERSISTENT_USER" | Out-File -FilePath $env:GITHUB_ENV -Append
          "RDP_PASSWORD=$env:PERSISTENT_PASSWORD" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure Ultra Optimized RDP
        run: |
          Write-Host "âš¡ Configuring ultra-optimized RDP..."
          
          # RDP Core Settings
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Extreme Performance Optimization
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxCompressionLevel" -Value 3 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MinEncryptionLevel" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxXResolution" -Value 1366 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxYResolution" -Value 768 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxColorDepth" -Value 16 -Force
          
          # Network Turbo Optimization
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' -Name "Tcp1323Opts" -Value 3 -Force
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' -Name "TCPWindowSize" -Value 65535 -Force
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' -Name "DefaultTTL" -Value 64 -Force
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP" 2>$null
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          Restart-Service -Name TermService -Force
          Write-Host "âœ… RDP ultra-optimized"

      - name: Install Essential Software
        run: |
          Write-Host "ğŸ“¦ Installing essential software..."
          
          # Táº¡o desktop shortcuts cho tiá»‡n Ã­ch
          $desktopPath = [Environment]::GetFolderPath("Desktop")
          $wscriptShell = New-Object -ComObject WScript.Shell
          
          # Shortcut for File Explorer
          $shortcut = $wscriptShell.CreateShortcut("$desktopPath\File Explorer.lnk")
          $shortcut.TargetPath = "explorer.exe"
          $shortcut.Save()
          
          # Shortcut for CMD
          $shortcut = $wscriptShell.CreateShortcut("$desktopPath\Command Prompt.lnk")
          $shortcut.TargetPath = "cmd.exe"
          $shortcut.Save()
          
          Write-Host "âœ… Essential shortcuts created"

      - name: Smart Tailscale Setup
        run: |
          Write-Host "ğŸ”— Setting up smart Tailscale connection..."
          
          # Kiá»ƒm tra Tailscale Ä‘Ã£ cÃ i chÆ°a
          if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
              Write-Host "ğŸ“¥ Installing Tailscale..."
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
              $installerPath = "$env:TEMP\tailscale.msi"
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
              Start-Process msiexec.exe -ArgumentList "/i", "$installerPath", "/quiet", "/norestart" -Wait
              Remove-Item $installerPath -Force
              Start-Sleep -Seconds 8
          }
          
          # Hostname cá»‘ Ä‘á»‹nh Ä‘á»ƒ dá»… nháº­n diá»‡n
          $hostname = "vietnam-rdp-pro"
          
          Write-Host "ğŸš€ Starting Tailscale with hostname: $hostname"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --login-server=https://login.tailscale.com --accept-routes --hostname=$hostname --reset
          
          # Hiá»ƒn thá»‹ QR code
          Start-Sleep -Seconds 5
          Write-Host "ğŸ” Scan this QR code or visit: https://login.tailscale.com/admin/machines"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --qr
          
          # Smart IP waiting vá»›i timeout
          $tsIP = $null
          $maxAttempts = 30
          for ($i = 1; $i -le $maxAttempts; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tsIP -and $tsIP.StartsWith('100.')) {
                  "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append
                  Write-Host "âœ… Connected! IP: $tsIP"
                  break
              }
              
              if ($i -eq 15) {
                  Write-Host "âš ï¸  Taking longer than usual... Please check Tailscale admin panel"
              }
              
              Write-Host "â³ Waiting for IP... ($i/$maxAttempts)"
              Start-Sleep -Seconds 3
          }
          
          if (-not $tsIP) {
              Write-Host "âŒ No IP received. Please authorize device manually."
              Write-Host "ğŸ”— Visit: https://login.tailscale.com/admin/machines"
              Write-Host "ğŸ” Look for: $hostname"
          }

      - name: Performance Boost
        run: |
          Write-Host "ğŸš€ Applying performance boost..."
          
          # Táº¯t services khÃ´ng cáº§n thiáº¿t
          $services = @("SysMain", "WSearch", "TabletInputService", "Spooler")
          foreach ($service in $services) {
              try {
                  Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                  Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                  Write-Host "âœ… Disabled: $service"
              } catch {
                  Write-Host "âš ï¸  Could not disable: $service"
              }
          }
          
          # High performance power plan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # Optimize for RDP
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Terminal Server Client' -Name "AuthenticationLevel" -Value 0 -Force
          
          Write-Host "âœ… Performance boost applied"

      - name: Display Pro Connection Info
        run: |
          Write-Host ""
          Write-Host "=" * 65
          Write-Host "ğŸš€ RDP PERSISTENT PRO - READY"
          Write-Host "=" * 65
          Write-Host "ğŸŒ CONNECTION:"
          Write-Host "   IP: $env:TAILSCALE_IP"
          Write-Host "   User: $env:RDP_USER"
          Write-Host "   Pass: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "ğŸ” AUTHENTICATION:"
          Write-Host "   URL: https://login.tailscale.com/admin/machines"
          Write-Host "   Device: vietnam-rdp-pro"
          Write-Host ""
          Write-Host "ğŸ“± MOBILE OPTIMIZED SETTINGS:"
          Write-Host "   â€¢ Security Layer: OFF"
          Write-Host "   â€¢ Resolution: 1366x768"
          Write_Host "   â€¢ Color: 16-bit"
          Write-Host "   â€¢ Compression: ON"
          Write-Host ""
          Write-Host "ğŸ’¡ PERSISTENT FEATURES:"
          Write-Host "   â€¢ Same credentials every time"
          Write-Host "   â€¢ Auto-reconnect every 6 hours"
          Write-Host "   â€¢ Same Tailscale device name"
          Write-Host "=" * 65
          Write-Host ""

      - name: Smart Session Manager
        run: |
          Write-Host "ğŸ”§ Smart Session Manager Started"
          Write-Host "ğŸ’¡ Next time, use the same credentials!"
          
          $sessionStart = Get-Date
          $lastHealthCheck = Get-Date
          $connectionCount = 0
          
          while ($true) {
              $currentTime = Get-Date
              $sessionDuration = [int](($currentTime - $sessionStart).TotalMinutes)
              
              # Health check every 10 minutes
              if (($currentTime - $lastHealthCheck).TotalMinutes -ge 10) {
                  $lastHealthCheck = $currentTime
                  
                  # Check Tailscale connection
                  $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
                  $status = if ($currentIP) { "âœ… CONNECTED" } else { "âŒ DISCONNECTED" }
                  
                  Write-Host "ğŸ¥ Health Check - $status - Session: $sessionDuration minutes"
                  
                  if ($currentIP -and $currentIP -ne $env:TAILSCALE_IP) {
                      Write-Host "ğŸ”„ IP Changed: $env:TAILSCALE_IP â†’ $currentIP"
                      "TAILSCALE_IP=$currentIP" | Out-File -FilePath $env:GITHUB_ENV -Append
                  }
              }
              
              # Status update every 5 minutes
              if ($sessionDuration % 5 -eq 0) {
                  Write-Host "[$(Get-Date -Format 'HH:mm')] Session Active - $sessionDuration minutes"
                  Write-Host "   ğŸ“ $env:TAILSCALE_IP | ğŸ‘¤ $env:RDP_USER"
                  Write-Host "   ğŸ’¡ Next: Use same credentials for quick reconnect"
              }
              
              # Auto-stop after 5 hours 50 minutes (trÆ°á»›c timeout)
              if ($sessionDuration -ge 350) {
                  Write-Host "ğŸ›‘ Auto-stopping session before timeout..."
                  break
              }
              
              Start-Sleep -Seconds 60
          }

  auto-restart:
    runs-on: ubuntu-latest
    needs: secure-rdp
    if: always()
    steps:
      - name: Check if Restart Needed
        run: |
          echo "ğŸ”„ This would trigger auto-restart if needed"
          # Trong thá»±c táº¿, báº¡n sáº½ trigger workflow má»›i á»Ÿ Ä‘Ã¢y
