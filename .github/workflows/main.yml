name: RDP Mobile Optimized

on:
  workflow_dispatch:

env:
  FIXED_PASSWORD: "Mobile@1234"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Clean Previous Session
        run: |
          Write-Host "ðŸ§¹ Cleaning previous session..."
          # Dá»«ng cÃ¡c process cÅ©
          Get-Process "tailscale*" -ErrorAction SilentlyContinue | Stop-Process -Force
          Start-Sleep -Seconds 2

      - name: Ultra Fast RDP Setup
        run: |
          Write-Host "âš¡ Configuring RDP..."
          # Sá»­ dá»¥ng reg command thay vÃ¬ PowerShell Ä‘á»ƒ trÃ¡nh lá»—i
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v SecurityLayer /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MaxColorDepth /t REG_DWORD /d 16 /f
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP" 2>$null
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Khá»Ÿi Ä‘á»™ng láº¡i service
          net stop TermService /y
          net start TermService

      - name: Create User
        run: |
          Write-Host "ðŸ‘¤ Creating user..."
          # XÃ³a user cÅ© náº¿u tá»“n táº¡i
          net user MobileUser /delete 2>$null
          
          # Táº¡o user má»›i
          net user MobileUser "$env:FIXED_PASSWORD" /add /y /expires:never
          net localgroup administrators MobileUser /add
          net localgroup "Remote Desktop Users" MobileUser /add

      - name: Install Tailscale
        run: |
          Write-Host "ðŸ“¥ Installing Tailscale..."
          # Kiá»ƒm tra xem Ä‘Ã£ cÃ i Ä‘áº·t chÆ°a
          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
            Write-Host "âœ… Tailscale already installed"
          } else {
            $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            
            # Táº£i xuá»‘ng
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
            # CÃ i Ä‘áº·t
            Start-Process msiexec.exe -ArgumentList "/i", "$installerPath", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            Write-Host "âœ… Tailscale installed"
          }
          
          # Chá» service khá»Ÿi Ä‘á»™ng
          Start-Sleep -Seconds 5

      - name: Configure Tailscale
        run: |
          Write-Host "ðŸ”— Configuring Tailscale..."
          
          # Äáº£m báº£o service Ä‘ang cháº¡y
          Start-Service "Tailscale" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          
          # Káº¿t ná»‘i Tailscale - Sá»¬A Lá»–I CHÃNH Táº¢ á»ž ÄÃ‚Y
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --login-server=https://login.tailscale.com --accept-routes --hostname=rdp-$env:GITHUB_RUN_ID
          
          Write-Host "âœ… Tailscale connection initiated"
          
          # Äá»£i vÃ  láº¥y IP
          $tsIP = $null
          for ($i = 0; $i -lt 15; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            if ($tsIP) { 
              Write-Host "ðŸŽ¯ Tailscale IP: $tsIP"
              "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append
              break 
            }
            Write-Host "â³ Waiting for IP... ($i/15)"
            Start-Sleep -Seconds 2
          }
          
          if (-not $tsIP) {
            Write-Host "âš ï¸ Could not get Tailscale IP, but continuing..."
            "TAILSCALE_IP=unknown" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Performance Optimization
        run: |
          Write-Host "ðŸš€ Optimizing performance..."
          # Power plan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          # Táº¯t services khÃ´ng cáº§n thiáº¿t
          net stop "SysMain" /y 2>$null
          Write-Host "âœ… Performance optimized"

      - name: Display Connection Info
        run: |
          # Láº¥y IP cuá»‘i cÃ¹ng
          $finalIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
          if (-not $finalIP) { $finalIP = "Check monitoring below" }
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "ðŸš€ RDP READY - CONNECT NOW"
          Write-Host "=========================================="
          Write-Host "ðŸ“ IP Address: $finalIP"
          Write-Host "ðŸ‘¤ Username: MobileUser"
          Write-Host "ðŸ”‘ Password: $env:FIXED_PASSWORD"
          Write-Host ""
          Write-Host "ðŸ“± CONNECTION GUIDE:"
          Write-Host "1. Open Remote Desktop Connection"
          Write-Host "2. Enter: $finalIP"
          Write-Host "3. Username: MobileUser"
          Write-Host "4. Password: $env:FIXED_PASSWORD"
          Write-Host ""
          Write-Host "âš¡ OPTIMAL CLIENT SETTINGS:"
          Write-Host "â€¢ Display: 1280x720, 16-bit color"
          Write-Host "â€¢ Experience: Low-speed broadband"
          Write-Host "â€¢ Turn OFF: Persistent bitmap caching"
          Write-Host "â€¢ Turn ON: Compression"
          Write-Host "=========================================="

      - name: Monitoring
        run: |
          Write-Host "ðŸ“Š Starting monitoring..."
          $counter = 0
          
          while ($true) {
            $counter++
            $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            
            if ($counter % 10 -eq 0) {
              # Hiá»ƒn thá»‹ thÃ´ng tin chi tiáº¿t má»—i 10 phÃºt
              if ($currentIP) {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] âœ… Active - $counter minutes | IP: $currentIP"
              } else {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] âš ï¸ Active - $counter minutes | IP: Waiting..."
                # Thá»­ káº¿t ná»‘i láº¡i
                & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset 2>$null
              }
            } elseif ($counter % 5 -eq 0) {
              # Hiá»ƒn thá»‹ Ä‘Æ¡n giáº£n má»—i 5 phÃºt
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Running... $counter minutes"
            }
            
            Start-Sleep -Seconds 60
          }
