name: RDP Mobile Optimized

on:
  workflow_dispatch:

env:
  FIXED_PASSWORD: "Mobile@1234"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Clean Previous Session
        run: |
          Write-Host "🧹 Cleaning previous session..."
          # Dừng các process cũ
          Get-Process "tailscale*" -ErrorAction SilentlyContinue | Stop-Process -Force
          Start-Sleep -Seconds 2

      - name: Ultra Fast RDP Setup
        run: |
          Write-Host "⚡ Configuring RDP..."
          # Sử dụng reg command thay vì PowerShell để tránh lỗi
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v SecurityLayer /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MaxColorDepth /t REG_DWORD /d 16 /f
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP" 2>$null
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Khởi động lại service
          net stop TermService /y
          net start TermService

      - name: Create User
        run: |
          Write-Host "👤 Creating user..."
          # Xóa user cũ nếu tồn tại
          net user MobileUser /delete 2>$null
          
          # Tạo user mới
          net user MobileUser "$env:FIXED_PASSWORD" /add /y /expires:never
          net localgroup administrators MobileUser /add
          net localgroup "Remote Desktop Users" MobileUser /add

      - name: Install Tailscale
        run: |
          Write-Host "📥 Installing Tailscale..."
          # Kiểm tra xem đã cài đặt chưa
          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
            Write-Host "✅ Tailscale already installed"
          } else {
            $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            
            # Tải xuống
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
            # Cài đặt
            Start-Process msiexec.exe -ArgumentList "/i", "$installerPath", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            Write-Host "✅ Tailscale installed"
          }
          
          # Chờ service khởi động
          Start-Sleep -Seconds 5

      - name: Configure Tailscale
        run: |
          Write-Host "🔗 Configuring Tailscale..."
          
          # Đảm bảo service đang chạy
          Start-Service "Tailscale" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          
          # Kết nối Tailscale - SỬA LỖI CHÍNH TẢ Ở ĐÂY
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --login-server=https://login.tailscale.com --accept-routes --hostname=rdp-$env:GITHUB_RUN_ID
          
          Write-Host "✅ Tailscale connection initiated"
          
          # Đợi và lấy IP
          $tsIP = $null
          for ($i = 0; $i -lt 15; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            if ($tsIP) { 
              Write-Host "🎯 Tailscale IP: $tsIP"
              "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append
              break 
            }
            Write-Host "⏳ Waiting for IP... ($i/15)"
            Start-Sleep -Seconds 2
          }
          
          if (-not $tsIP) {
            Write-Host "⚠️ Could not get Tailscale IP, but continuing..."
            "TAILSCALE_IP=unknown" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Performance Optimization
        run: |
          Write-Host "🚀 Optimizing performance..."
          # Power plan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          # Tắt services không cần thiết
          net stop "SysMain" /y 2>$null
          Write-Host "✅ Performance optimized"

      - name: Display Connection Info
        run: |
          # Lấy IP cuối cùng
          $finalIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
          if (-not $finalIP) { $finalIP = "Check monitoring below" }
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "🚀 RDP READY - CONNECT NOW"
          Write-Host "=========================================="
          Write-Host "📍 IP Address: $finalIP"
          Write-Host "👤 Username: MobileUser"
          Write-Host "🔑 Password: $env:FIXED_PASSWORD"
          Write-Host ""
          Write-Host "📱 CONNECTION GUIDE:"
          Write-Host "1. Open Remote Desktop Connection"
          Write-Host "2. Enter: $finalIP"
          Write-Host "3. Username: MobileUser"
          Write-Host "4. Password: $env:FIXED_PASSWORD"
          Write-Host ""
          Write-Host "⚡ OPTIMAL CLIENT SETTINGS:"
          Write-Host "• Display: 1280x720, 16-bit color"
          Write-Host "• Experience: Low-speed broadband"
          Write-Host "• Turn OFF: Persistent bitmap caching"
          Write-Host "• Turn ON: Compression"
          Write-Host "=========================================="

      - name: Monitoring
        run: |
          Write-Host "📊 Starting monitoring..."
          $counter = 0
          
          while ($true) {
            $counter++
            $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            
            if ($counter % 10 -eq 0) {
              # Hiển thị thông tin chi tiết mỗi 10 phút
              if ($currentIP) {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ✅ Active - $counter minutes | IP: $currentIP"
              } else {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ⚠️ Active - $counter minutes | IP: Waiting..."
                # Thử kết nối lại
                & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset 2>$null
              }
            } elseif ($counter % 5 -eq 0) {
              # Hiển thị đơn giản mỗi 5 phút
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Running... $counter minutes"
            }
            
            Start-Sleep -Seconds 60
          }
